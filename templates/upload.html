<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>×“×©×‘×•×¨×“ ×›×¨×™×ª×ª ×¢×¦×™× ğŸŒ³</title>
  <style>
    body { font-family: Arial; text-align: center; margin-top: 30px; background-color: #f5f5f5; }
    h2, h3, h4 { color: #2b5329; }
    table { margin: 0 auto; border-collapse: collapse; width: 60%; direction: rtl; background: white; border-radius: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    canvas { max-width: 700px; margin: 40px auto; display: block; background: white; border-radius: 12px; padding: 15px; }
    button { background: #4CAF50; color: white; border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer; }
    button:hover { background: #388E3C; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2>ğŸŒ² ××¢×¨×›×ª ×“×•×—×•×ª ×›×¨×™×ª×ª ×¢×¦×™× ×‘×™×©×¨××œ</h2>
  <form id="uploadForm">
    <label>ğŸ“ ×§×•×‘×¥ ×¢×¦×™×:</label><br>
    <input type="file" name="file1" accept=".xlsx" required><br><br>

    <label>ğŸ“ ×§×•×‘×¥ ×¢×¨×¢×¨×™×:</label><br>
    <input type="file" name="file2" accept=".xlsx" required><br><br>

    <button type="submit">×”×¢×œ×” ×•×¢×‘×“ ×§×‘×¦×™×</button>
  </form>

  <div id="loading" style="display:none;">××¢×‘×“ × ×ª×•× ×™×... ×× × ×”××ª×Ÿ ğŸŒ³</div>
  <div id="result"></div>

  <div class="charts">
    <h4>ğŸ·ï¸ 10 ×”×¢×¨×™× ×¢× ×”×›×™ ×”×¨×‘×” ×¨×™×©×™×•× ×•×ª ×›×¨×™×ª×”</h4>
    <canvas id="licenseChart"></canvas>

    <h4>ğŸŒ´ 10 ×¡×•×’×™ ×”×¢×¦×™× ×©× ×›×¨×ª×• ×”×›×™ ×”×¨×‘×”</h4>
    <canvas id="treeChart"></canvas>

    <h4>ğŸª“ 10 ×”×¡×™×‘×•×ª ×”×©×›×™×—×•×ª ×‘×™×•×ª×¨ ×œ×›×¨×™×ª×ª ×¢×¦×™×</h4>
    <canvas id="reasonBarChart"></canvas>

    <h4>ğŸ›ï¸ 10 ×”×¢×¨×™× ×©×‘×”×Ÿ ×”×•×’×©×• ×”×›×™ ×”×¨×‘×” ×¢×¨×¨×™× ×œ×”×¦×œ×ª ×¢×¦×™×</h4>
    <canvas id="appealCitiesChart"></canvas>

    <h4>ğŸŒ³ 10 ×”×¢×¨×¨×™× ×”×’×“×•×œ×™× ×‘×™×•×ª×¨ ×©××•×©×¨×• ×œ×©×™××•×¨ ×¢×¦×™×</h4>
    <canvas id="topAppealsChart"></canvas>

    <h4>ğŸªµ ×”×¡×™×‘×•×ª ×”× ×¤×•×¦×•×ª ×‘×™×•×ª×¨ ×‘×¢×¨×¨×™× ×©×”×¦×œ×™×—×•</h4>
    <canvas id="appealReasonsChart"></canvas>
  </div>

  <script>
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      document.getElementById('loading').style.display = 'block';
      document.getElementById('result').innerHTML = '';

      const response = await fetch('/upload', { method: 'POST', body: formData });
      const data = await response.json();
      document.getElementById('loading').style.display = 'none';

      if (data.error) {
        document.getElementById('result').innerText = data.error;
        return;
      }

      // === ×˜×‘×œ×” ===
      let html = `
        <p><a href="/download/MergeFile.xlsx">ğŸ“¥ ×”×•×¨×“ ××ª ×§×•×‘×¥ ×”×¢×¦×™× ×”××¢×•×‘×“</a></p>
        <p><a href="/download/Appellants_Analyzed.xlsx">ğŸ“¥ ×”×•×¨×“ ××ª ×§×•×‘×¥ ×”×¢×¨×¢×¨×™× ×”××¢×•×‘×“</a></p>
        <h3>10 ×”×¢×¨×™× ×©×‘×”×Ÿ × ×›×¨×ª×• ×”×›×™ ×”×¨×‘×” ×¢×¦×™× ğŸŒ³</h3>
        <table><tr><th>×¢×™×¨</th><th>××¡×¤×¨ ×¢×¦×™×</th></tr>`;
      
      data.top_cities.forEach(row => {
        html += `<tr><td>${row.City}</td><td>${row.numberOfTrees}</td></tr>`;
      });
      html += `</table>

      <h4>ğŸ™ï¸ ×¤×™×œ×•×— ×›×œ ×”×¢×¨×™× ×œ×¤×™ ××—×•×– ×”×¢×¦×™× ×©× ×›×¨×ª×•</h4>
      <canvas id="cityPieChart"></canvas>`;

      document.getElementById('result').innerHTML = html;

      // âœ… ×’×¨×£ ××—×•×–×™× ×œ×¤×™ ×¢×™×¨
      const cityLabels = (data.city_distribution_percent || []).map(r => r.City);
      const cityPercents = (data.city_distribution_percent || []).map(r => r.Percent);

      new Chart(document.getElementById('cityPieChart'), {
        type: 'pie',
        data: {
          labels: cityLabels,
          datasets: [{
            data: cityPercents,
            backgroundColor: [
              '#4caf50', '#81c784', '#c8e6c9', '#2e7d32',
              '#66bb6a', '#a5d6a7', '#388e3c', '#43a047',
              '#9ccc65', '#b9f6ca'
            ]
          }]
        },
        options: {
          plugins: {
            title: { display: true, text: 'ğŸ™ï¸ ×¤×™×œ×•×— ×¢×¨×™× ×œ×¤×™ ××—×•×– ×”×¢×¦×™× ×©× ×›×¨×ª×• (%)' },
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed;
                  return `${label}: ${value}%`;
                }
              }
            }
          }
        }
      });

      // === ×’×¨×£ ×¨×™×©×™×•× ×•×ª ×›×¨×™×ª×” ===
      if (data.top_licenses) {
        new Chart(document.getElementById('licenseChart'), {
          type: 'bar',
          data: {
            labels: data.top_licenses.map(r => r.City),
            datasets: [{
              label: '××¡×¤×¨ ×¨×™×©×™×•× ×•×ª ×›×¨×™×ª×”',
              data: data.top_licenses.map(r => r.LicenseCount),
              backgroundColor: '#6d9e52'
            }]
          },
          options: {
            plugins: {
              legend: { display: false },
              title: { display: true, text: 'ğŸ·ï¸ 10 ×”×¢×¨×™× ×¢× ×”×›×™ ×”×¨×‘×” ×¨×™×©×™×•× ×•×ª ×›×¨×™×ª×”' }
              // âŒ ×”×¡×¨×ª datalabels ×›×“×™ ×©×œ× ×™×•×¦×’×• ××¡×¤×¨×™× ××¢×œ ×›×œ ×¢××•×“×”
            },
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
          }
        });
      }

      // === ×’×¨×£ ×¡×•×’×™ ×¢×¦×™× ===
      new Chart(document.getElementById('treeChart'), {
        type: 'bar',
        data: {
          labels: data.top_trees.map(r => r.TreeName),
          datasets: [{
            label: '××¡×¤×¨ ×›×¨×™×ª×•×ª ×œ×¤×™ ××™×Ÿ ×¢×¥',
            data: data.top_trees.map(r => r.numberOfTrees),
            backgroundColor: '#2e7d32'
          }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });

      // === ×’×¨×£ ×¡×™×‘×•×ª ×›×¨×™×ª×” ===
      new Chart(document.getElementById('reasonBarChart'), {
        type: 'bar',
        data: {
          labels: data.top_reasons.map(r => r.Reason),
          datasets: [{
            label: '××¡×¤×¨ ××•×¤×¢×™×',
            data: data.top_reasons.map(r => r.Count),
            backgroundColor: '#8bc34a'
          }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });

      // === ×’×¨×£ ×¢×¨×™× ×¢× ×¢×¨×¨×™× ===
      if (data.appeal_cities) {
        new Chart(document.getElementById('appealCitiesChart'), {
          type: 'bar',
          data: {
            labels: data.appeal_cities.map(r => r.city),
            datasets: [{
              label: '××¡×¤×¨ ×¢×¨×¨×™× ×œ×”×¦×œ×ª ×¢×¦×™×',
              data: data.appeal_cities.map(r => r.count),
              backgroundColor: '#66bb6a'
            }]
          },
          options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
      }

      // === ×’×¨×£ ×¢×¨×¨×™× ×©×”×¦×œ×™×—×• ===
      if (data.top_successful_appeals) {
        new Chart(document.getElementById('topAppealsChart'), {
          type: 'bar',
          data: {
            labels: data.top_successful_appeals.map(r => r.city),
            datasets: [{
              label: '××¡×¤×¨ ×¢×¦×™× ×©× ×©××¨×•',
              data: data.top_successful_appeals.map(r => r.saved),
              backgroundColor: '#43a047'
            }]
          },
          options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
      }

      // === ×’×¨×£ ×¡×™×‘×•×ª ×‘×¢×¨×¨×™× ××•×¦×œ×—×™× ===
      if (data.appeal_reasons) {
        const total = data.appeal_reasons.reduce((sum, r) => sum + r.count, 0);
        new Chart(document.getElementById('appealReasonsChart'), {
          type: 'pie',
          data: {
            labels: data.appeal_reasons.map(r => r.reason),
            datasets: [{
              data: data.appeal_reasons.map(r => r.count),
              backgroundColor: [
                '#2e7d32', '#66bb6a', '#81c784', '#a5d6a7',
                '#388e3c', '#43a047', '#4caf50', '#9ccc65',
                '#b9f6ca', '#c8e6c9'
              ]
            }]
          },
          options: {
            plugins: {
              title: { display: true, text: 'ğŸªµ ×¡×™×‘×•×ª × ×¤×•×¦×•×ª ×‘×¢×¨×¨×™× ×©×”×¦×œ×™×—×•' },
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed;
                    const percent = ((value / total) * 100).toFixed(1);
                    return `${label}: ${value} (${percent}%)`;
                  }
                }
              }
            }
          }
        });
      }

    });
  </script>
</body>
</html>
