<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>×“×•×—×•×ª ×›×¨×™×ª×ª ×¢×¦×™× ğŸŒ³</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* ========= General Styles ========= */
    body {
      margin: 0;
      font-family: 'Inter', Arial, sans-serif;
      color: #1b5e20;
      background: #f8faf9;
      scroll-behavior: smooth;
    }

    header {
      background: linear-gradient(135deg, #4CAF50, #81C784);
      color: white;
      text-align: center;
      padding: 80px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    header h2 {
      font-size: 2.8em;
      margin-bottom: 0;
      color: #ffffff;
    }

    /* ========= Processing Section ========= */
    section {
      max-width: 1000px;
      margin: 60px auto;
      background: white;
      padding: 40px 50px;
      border-radius: 18px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    h2, h3, h4 {
      color: #2e7d32;
      text-align: center;
      margin-bottom: 20px;
    }

    /* ========= Upload Form ========= */
    form {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      background: #f9fdf9;
      border: 1px solid #dcedc8;
      border-radius: 14px;
      padding: 25px 30px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.05);
      width: 80%;
      margin: 0 auto 30px;
    }

    input[type="file"] {
      padding: 8px;
      border: 1px solid #c8e6c9;
      border-radius: 6px;
      background: #fff;
    }

    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s ease;
    }

    button:hover {
      background: #388E3C;
    }

    /* ========= Table ========= */
    table {
      margin: 30px auto;
      border-collapse: collapse;
      width: 70%;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    th {
      background: #4CAF50;
      color: white;
      padding: 10px;
    }

    td {
      border: 1px solid #ddd;
      padding: 8px;
    }

    tr:nth-child(even) { background-color: #f9f9f9; }

    a {
      color: #2e7d32;
      text-decoration: none;
      font-weight: bold;
    }

    a:hover {
      text-decoration: underline;
    }

    /* ========= Charts Section ========= */
    .charts {
      display: none; /* Hidden at first */
    }

    .charts h4 {
      margin-top: 50px;
      text-align: center;
      color: #2e7d32;
    }

    canvas {
      max-width: 800px;
      margin: 40px auto;
      display: block;
      background: #ffffff;
      border-radius: 12px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    /* ========= Loading ========= */
    #loading {
      text-align: center;
      color: #2e7d32;
      font-size: 1.1em;
      margin-top: 15px;
    }

    /* ========= Footer ========= */
    footer {
      text-align: center;
      background: #e8f5e9;
      color: #444;
      font-size: 0.9em;
      padding: 30px 10px;
      margin-top: 60px;
      border-top: 1px solid #c8e6c9;
    }

    /* ========= Center Download Links ========= */
    #result p {
      text-align: center;
    }

    #result a {
      display: inline-block;
      margin: 5px 0;
      font-size: 1.05em;
    }
  </style>
</head>
<body>

  <header>
    <h2>ğŸŒ³ ××¢×¨×›×ª ×¢×™×‘×•×“ ×“×•×—×•×ª ×›×¨×™×ª×ª ×¢×¦×™× ğŸŒ³</h2>
  </header>

  <section>
    <form id="uploadForm">
      <label>ğŸ“ ×“×•×— ×›×¨×™×ª×ª ×¢×¦×™×:</label>
      <input type="file" name="file1" accept=".xlsx" required>

      <label>ğŸ“ ×“×•×— ×¢×¨×¨×™×:</label>
      <input type="file" name="file2" accept=".xlsx" required>

      <button type="submit">×¢×‘×“ ×§×‘×¦×™×</button>
    </form>

    <div id="loading" style="display:none;">××¢×‘×“ × ×ª×•× ×™×... ×× × ×”××ª×Ÿ ğŸŒ³</div>
    <div id="result"></div>

    <div class="charts">
      <h4>ğŸ“‹ 10 ×”×¢×¨×™× ×¢× ×”×›×™ ×”×¨×‘×” ×¨×™×©×™×•× ×•×ª ×›×¨×™×ª×” ğŸ“‹</h4>
      <canvas id="licenseChart"></canvas>

      <h4>ğŸŒ´ 10 ×¡×•×’×™ ×”×¢×¦×™× ×©× ×›×¨×ª×• ×”×›×™ ×”×¨×‘×” ğŸŒ´</h4>
      <canvas id="treeChart"></canvas>

      <h4>ğŸª“ 10 ×”×¡×™×‘×•×ª ×”×©×›×™×—×•×ª ×‘×™×•×ª×¨ ×œ×›×¨×™×ª×ª ×¢×¦×™× ğŸª“</h4>
      <canvas id="reasonBarChart"></canvas>

      <h4>ğŸ›ï¸ 10 ×”×¢×¨×™× ×©×‘×”×Ÿ ×”×•×’×©×• ×”×›×™ ×”×¨×‘×” ×¢×¨×¨×™× ×œ×”×¦×œ×ª ×¢×¦×™× ğŸ›ï¸</h4>
      <canvas id="appealCitiesChart"></canvas>

      <h4>ğŸŒ³ 10 ×”×¢×¨×¨×™× ×”×’×“×•×œ×™× ×‘×™×•×ª×¨ ×©××•×©×¨×• ×œ×©×™××•×¨ ×¢×¦×™× ğŸŒ³</h4>
      <canvas id="topAppealsChart"></canvas>

      <h4>ğŸªµ ×”×¡×™×‘×•×ª ×”× ×¤×•×¦×•×ª ×‘×™×•×ª×¨ ×‘×¢×¨×¨×™× ×©×”×¦×œ×™×—×• ğŸªµ</h4>
      <canvas id="appealReasonsChart"></canvas>
    </div>
  </section>

  <footer>
    2025 Gil Hadad & Inbar Abraham | Ono Academic College | Trees Dashboard
  </footer>

  <script>
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      document.getElementById('loading').style.display = 'block';
      document.getElementById('result').innerHTML = '';
      document.querySelector('.charts').style.display = 'none'; // Hide charts during processing

      const response = await fetch('/upload', { method: 'POST', body: formData });
      const data = await response.json();
      document.getElementById('loading').style.display = 'none';

      if (data.error) {
        document.getElementById('result').innerText = data.error;
        return;
      }

      // Show charts only after successful upload
      document.querySelector('.charts').style.display = 'block';

      let html = `
        <p><a href="/download/MergeFile.xlsx">ğŸ“¥ ×”×•×¨×“ ××ª ×§×•×‘×¥ ×”×¢×¦×™× ×”××¢×•×‘×“</a></p>
        <p><a href="/download/Appellants_Analyzed.xlsx">ğŸ“¥ ×”×•×¨×“ ××ª ×§×•×‘×¥ ×”×¢×¨×¨×™× ×”××¢×•×‘×“</a></p>
        <h3>ğŸŒ³ 10 ×”×¢×¨×™× ×©× ×›×¨×ª×• ×‘×”×Ÿ ×”×›×™ ×”×¨×‘×” ×¢×¦×™× ğŸŒ³</h3>
        <table><tr><th>×¢×™×¨</th><th>××¡×¤×¨ ×¢×¦×™×</th></tr>`;
      
      data.top_cities.forEach(row => {
        html += `<tr><td>${row.City}</td><td>${row.numberOfTrees}</td></tr>`;
      });
      html += `</table>
      <h4>ğŸ™ï¸ ×¤×™×œ×•×— ×›×œ ×”×¢×¨×™× ×œ×¤×™ ××—×•×– ×”×¢×¦×™× ×©× ×›×¨×ª×• ğŸ™ï¸</h4>
      <canvas id="cityPieChart"></canvas>`;

      document.getElementById('result').innerHTML = html;

      const cityLabels = (data.city_distribution_percent || []).map(r => r.City);
      const cityPercents = (data.city_distribution_percent || []).map(r => r.Percent);

      new Chart(document.getElementById('cityPieChart'), {
        type: 'pie',
        data: {
          labels: cityLabels,
          datasets: [{
            data: cityPercents,
            backgroundColor: [
              '#4caf50', '#81c784', '#c8e6c9', '#2e7d32',
              '#66bb6a', '#a5d6a7', '#388e3c', '#43a047',
              '#9ccc65', '#b9f6ca'
            ]
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed;
                  return `${label}: ${value}%`;
                }
              }
            }
          }
        }
      });

      if (data.top_licenses) {
        new Chart(document.getElementById('licenseChart'), {
          type: 'bar',
          data: {
            labels: data.top_licenses.map(r => r.City),
            datasets: [{
              label: '××¡×¤×¨ ×¨×™×©×™×•× ×•×ª ×›×¨×™×ª×”',
              data: data.top_licenses.map(r => r.LicenseCount),
              backgroundColor: '#6d9e52'
            }]
          },
          options: {
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
          }
        });
      }

      new Chart(document.getElementById('treeChart'), {
        type: 'bar',
        data: {
          labels: data.top_trees.map(r => r.TreeName),
          datasets: [{
            label: '××¡×¤×¨ ×›×¨×™×ª×•×ª ×œ×¤×™ ××™×Ÿ ×¢×¥',
            data: data.top_trees.map(r => r.numberOfTrees),
            backgroundColor: '#2e7d32'
          }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });

      new Chart(document.getElementById('reasonBarChart'), {
        type: 'bar',
        data: {
          labels: data.top_reasons.map(r => r.Reason),
          datasets: [{
            label: '××¡×¤×¨ ××•×¤×¢×™×',
            data: data.top_reasons.map(r => r.Count),
            backgroundColor: '#8bc34a'
          }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });

      if (data.appeal_cities) {
        new Chart(document.getElementById('appealCitiesChart'), {
          type: 'bar',
          data: {
            labels: data.appeal_cities.map(r => r.city),
            datasets: [{
              label: '××¡×¤×¨ ×¢×¨×¨×™× ×œ×”×¦×œ×ª ×¢×¦×™×',
              data: data.appeal_cities.map(r => r.count),
              backgroundColor: '#66bb6a'
            }]
          },
          options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
      }

      if (data.top_successful_appeals) {
        new Chart(document.getElementById('topAppealsChart'), {
          type: 'bar',
          data: {
            labels: data.top_successful_appeals.map(r => r.city),
            datasets: [{
              label: '××¡×¤×¨ ×¢×¦×™× ×©× ×©××¨×•',
              data: data.top_successful_appeals.map(r => r.saved),
              backgroundColor: '#43a047'
            }]
          },
          options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
      }

      if (data.appeal_reasons) {
        const total = data.appeal_reasons.reduce((sum, r) => sum + r.count, 0);
        new Chart(document.getElementById('appealReasonsChart'), {
          type: 'pie',
          data: {
            labels: data.appeal_reasons.map(r => r.reason),
            datasets: [{
              data: data.appeal_reasons.map(r => r.count),
              backgroundColor: [
                '#2e7d32', '#66bb6a', '#81c784', '#a5d6a7',
                '#388e3c', '#43a047', '#4caf50', '#9ccc65',
                '#b9f6ca', '#c8e6c9'
              ]
            }]
          },
          options: {
            plugins: {
              title: { display: true, text: 'ğŸªµ ×¡×™×‘×•×ª × ×¤×•×¦×•×ª ×‘×¢×¨×¨×™× ×©×”×¦×œ×™×—×•' },
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed;
                    const percent = ((value / total) * 100).toFixed(1);
                    return `${label}: ${value} (${percent}%)`;
                  }
                }
              }
            }
          }
        });
      }

    });
  </script>
</body>
</html>
